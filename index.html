<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Zinc Text-Based RPG Lobby Generator</title>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    :root { color-scheme: dark; }

    /* Subtle CRT / terminal vibe (zinc-only) — optimized to avoid shimmer/flicker */
    .scanlines::before {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      background:
        repeating-linear-gradient(
          to bottom,
          rgba(255,255,255,0.02),
          rgba(255,255,255,0.02) 1px,
          rgba(0,0,0,0) 3px,
          rgba(0,0,0,0) 7px
        );
      opacity: 0.14;
      z-index: 50;
      will-change: transform;
      transform: translateZ(0);
    }

    /* Static grain (no animation to prevent flicker on some GPUs/browsers) */
    .scanlines::after {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      background-image: radial-gradient(rgba(255,255,255,0.05) 0.8px, transparent 0.8px);
      background-size: 28px 28px;
      opacity: 0.02;
      z-index: 49;
      filter: blur(0.25px);
      will-change: transform;
      transform: translateZ(0);
    }

    /* Very subtle header flicker (optional) */
    @keyframes flicker {
      0% { opacity: 1; }
      8% { opacity: 0.985; }
      16% { opacity: 0.995; }
      24% { opacity: 0.99; }
      32% { opacity: 1; }
      100% { opacity: 0.995; }
    }
    .flicker { animation: flicker 12s ease-in-out infinite; }

    /* A subtle “cursor” block */
    @keyframes cursorBlink {
      0%, 49% { opacity: 1; }
      50%, 100% { opacity: 0; }
    }
    .cursor {
      width: 0.62rem;
      height: 1.05rem;
      display: inline-block;
      background: rgba(244,244,245,0.72);
      transform: translateY(2px);
      animation: cursorBlink 1.05s steps(1, end) infinite;
    }

    body {
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    @media (prefers-reduced-motion: reduce) {
      .flicker, .cursor { animation: none !important; }
      * { scroll-behavior: auto !important; }
    }
  </style>
</head>
<body class="scanlines min-h-screen bg-zinc-950 text-zinc-200">
  <div class="min-h-screen flex items-center justify-center p-6">
    <div class="w-full max-w-5xl">
      <div class="relative overflow-hidden rounded-2xl border border-zinc-700/60 bg-zinc-950/70 shadow-[0_0_0_1px_rgba(255,255,255,0.03)]">
        <div class="absolute inset-0 pointer-events-none bg-gradient-to-b from-zinc-900/20 via-transparent to-zinc-900/25"></div>

        <!-- Top status line -->
        <div class="relative flex items-center justify-between gap-3 px-6 py-4 border-b border-zinc-800/70">
          <div class="flex items-center gap-2 text-xs text-zinc-400">
            <span class="inline-block h-2.5 w-2.5 rounded-full bg-zinc-700"></span>
            <span class="inline-block h-2.5 w-2.5 rounded-full bg-zinc-800"></span>
            <span class="inline-block h-2.5 w-2.5 rounded-full bg-zinc-900 ring-1 ring-zinc-700/60"></span>
            <span class="ml-2 tracking-wide">LOCAL NODE: /lobby</span>
          </div>
          <div class="hidden sm:flex items-center gap-2 text-xs text-zinc-500">
            <span>SYNC</span>
            <span class="text-zinc-400">OK</span>
            <span class="text-zinc-600">•</span>
            <span id="clock" class="tabular-nums">--:--:--</span>
          </div>
        </div>

        <!-- Title / brand (always visible) -->
        <div class="relative px-6 md:px-8 py-6 border-b border-zinc-800/70">
          <div class="flex items-start justify-between gap-6">
            <div>
              <h1 id="brandTitle" class="text-2xl sm:text-3xl font-semibold tracking-tight text-zinc-50">
                ZINC//LOBBY <span class="text-zinc-400 font-light">v</span><span class="text-zinc-300 font-medium">1</span>
                <span class="ml-2 align-middle cursor" aria-hidden="true"></span>
              </h1>
              <p class="mt-2 text-sm text-zinc-400 leading-relaxed">
                Single-user terminal. Quiet streets. No neon. Just output.
              </p>
            </div>

            <div class="hidden sm:block text-xs text-zinc-500 leading-relaxed text-right">
              <div class="tracking-wide">KEYS</div>
              <div class="mt-2 space-y-1">
                <div><span class="text-zinc-400">↑/↓</span> select</div>
                <div><span class="text-zinc-400">Enter</span> open</div>
                <div><span class="text-zinc-400">Esc</span> menu</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Stage: either menu-only OR context-only -->
        <div id="stage" class="relative">
          <!-- Menu view (default) -->
          <div id="menuPane" class="p-6 md:p-10">
            <nav aria-label="Main menu" class="space-y-2 max-w-xl mx-auto" id="menu">
              <!-- Buttons injected by JS to keep selection logic centralized -->
            </nav>
          </div>

          <!-- Context view (hidden until you pick a menu item) -->
          <div id="contextPane" class="hidden p-6 md:p-8">
            <div class="flex items-start justify-between gap-4">
              <div>
                <div class="text-xs text-zinc-500 tracking-wide">CONTEXT</div>
                <h2 id="panelTitle" class="mt-2 text-xl font-semibold text-zinc-100">Idle</h2>
              </div>
              <div class="flex items-start gap-3">
                <button id="backToMenuBtn" type="button" class="px-3 py-2 text-xs rounded-lg border bg-zinc-900/40 border-zinc-700/70 text-zinc-200 hover:bg-zinc-800/60 hover:border-zinc-600/80 transition-colors focus:outline-none focus:ring-2 focus:ring-zinc-600/40">
                  MENU
                </button>
                <div class="text-right">
                  <div class="text-xs text-zinc-500 tracking-wide">SESSION</div>
                  <div class="mt-2 text-sm text-zinc-300"><span class="text-zinc-500">USER:</span> SOLO</div>
                </div>
              </div>
            </div>

            <div class="mt-5 rounded-xl border border-zinc-800/80 bg-zinc-950/40 overflow-hidden">
              <div class="px-4 py-3 border-b border-zinc-800/70 flex items-center justify-between">
                <div class="text-xs text-zinc-500 tracking-wide">OUTPUT</div>
                <div id="panelBadge" class="text-[11px] text-zinc-400 border border-zinc-700/70 bg-zinc-900/40 rounded-md px-2 py-1">READY</div>
              </div>
              <div class="p-4">
                <div id="panel" class="transition-all duration-300 ease-out">
                  <p class="text-sm text-zinc-300 leading-relaxed">Awaiting command.</p>
                </div>

                <!-- Action row (varies by menu) -->
                <div id="actions" class="mt-4 flex flex-wrap gap-2"></div>
              </div>
            </div>

            <div class="mt-5 rounded-xl border border-zinc-800/70 bg-zinc-950/30 p-4">
              <div class="text-xs text-zinc-500 tracking-wide">SYSTEM NOTE</div>
              <p id="systemNote" class="mt-2 text-sm text-zinc-400 leading-relaxed">
                Keep it simple. Keep it quiet. Ship the mission.
              </p>
            </div>
          </div>
        </div>

        <footer class="relative px-6 py-4 border-t border-zinc-800/70 flex items-center justify-between">
          <div class="text-xs text-zinc-500">
            <span class="text-zinc-400">BUILD</span> z-lobby.1.0.0 <span class="text-zinc-600">/</span> <span class="text-zinc-400">MODE</span> single-player
          </div>
          <div class="text-xs text-zinc-600">© <span id="year"></span> Zinc Systems</div>
        </footer>
      </div>

      <div class="mt-4 text-[11px] text-zinc-600 px-1">
        Hint: This lobby is purely local and text-driven. No map. No network. Just choices.
      </div>
    </div>
  </div>

  <script>
    const menuItems = [
      { id: 'start', label: 'Start Mission' },
      { id: 'load', label: 'Load Data' },
      { id: 'settings', label: 'Settings' },
      { id: 'credits', label: 'Credits' },
    ];

    const state = {
      view: 'menu',
      selectedIndex: 0,
      lastAction: null,
      settings: {
        // Defaults optimized for stability (no visible flicker)
        textFlicker: false,
        scanlines: true,
        reducedOutput: false,
      },
      saveSlots: [],
    };

    const elMenu = document.getElementById('menu');
    const elMenuPane = document.getElementById('menuPane');
    const elContextPane = document.getElementById('contextPane');

    const elPanel = document.getElementById('panel');
    const elPanelTitle = document.getElementById('panelTitle');
    const elPanelBadge = document.getElementById('panelBadge');
    const elActions = document.getElementById('actions');
    const elSystemNote = document.getElementById('systemNote');

    function setView(view) {
      state.view = view;
      const isMenu = view === 'menu';

      elMenuPane.classList.toggle('hidden', !isMenu);
      elContextPane.classList.toggle('hidden', isMenu);

      window.setTimeout(() => {
        if (isMenu) {
          const buttons = Array.from(elMenu.querySelectorAll('button'));
          const btn = buttons[state.selectedIndex] || buttons[0];
          btn?.focus({ preventScroll: true });
        } else {
          document.getElementById('backToMenuBtn')?.focus?.({ preventScroll: true });
        }
      }, 40);
    }

    function backToMenu(note) {
      if (typeof note === 'string' && note.trim()) {
        elSystemNote.textContent = note;
      }
      setIdle();
      setView('menu');
    }

    function setPanel({ title, badge = 'READY', contentHTML, actions = [] }) {
      elPanel.classList.add('opacity-0', 'translate-y-1');
      elPanel.classList.remove('opacity-100', 'translate-y-0');

      window.setTimeout(() => {
        elPanelTitle.textContent = title;
        elPanelBadge.textContent = badge;
        elPanel.innerHTML = contentHTML;

        elActions.innerHTML = '';
        for (const a of actions) {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = [
            'px-3 py-2 text-sm rounded-lg border',
            'bg-zinc-900/40 border-zinc-700/70',
            'text-zinc-200',
            'hover:bg-zinc-800/60 hover:border-zinc-600/80',
            'transition-colors duration-200',
            'focus:outline-none focus:ring-2 focus:ring-zinc-600/40 focus:ring-offset-0'
          ].join(' ');
          btn.textContent = a.label;
          btn.addEventListener('click', a.onClick);
          elActions.appendChild(btn);
        }

        elPanel.classList.remove('opacity-0', 'translate-y-1');
        elPanel.classList.add('opacity-100', 'translate-y-0');
      }, 120);
    }

    function makeMenuButton(item, idx) {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.dataset.index = String(idx);
      btn.dataset.id = item.id;
      btn.className = [
        'w-full text-left group',
        'rounded-xl border',
        'bg-zinc-900/20 border-zinc-700/60',
        'hover:bg-zinc-900/35 hover:border-zinc-600/70',
        'transition-all duration-200',
        'px-4 py-4',
        'focus:outline-none focus:ring-2 focus:ring-zinc-600/40'
      ].join(' ');

      const line1 = document.createElement('div');
      line1.className = 'flex items-center justify-between gap-3';

      const left = document.createElement('div');
      left.className = 'flex items-center gap-3';

      const sig = document.createElement('div');
      sig.className = 'text-xs text-zinc-500 tabular-nums';
      sig.textContent = String(idx + 1).padStart(2, '0');

      const label = document.createElement('div');
      label.className = 'text-sm sm:text-base text-zinc-100';
      label.textContent = item.label;

      left.appendChild(sig);
      left.appendChild(label);

      const hint = document.createElement('div');
      hint.className = 'text-xs text-zinc-500 group-hover:text-zinc-400 transition-colors';
      hint.textContent = 'ENTER';

      line1.appendChild(left);
      line1.appendChild(hint);

      const sub = document.createElement('div');
      sub.className = 'mt-1 text-xs text-zinc-500';
      sub.textContent = menuSubtext(item.id);

      btn.appendChild(line1);
      btn.appendChild(sub);

      btn.addEventListener('mouseenter', () => {
        state.selectedIndex = idx;
        renderMenuSelection();
      });
      btn.addEventListener('focus', () => {
        state.selectedIndex = idx;
        renderMenuSelection();
      });
      btn.addEventListener('click', () => executeMenu(item.id));

      return btn;
    }

    function menuSubtext(id) {
      switch (id) {
        case 'start': return 'Initialize briefing and deploy.';
        case 'load': return 'Scan local storage for fragments.';
        case 'settings': return 'Tune the terminal, keep it subtle.';
        case 'credits': return 'Identify contributors and license.';
        default: return '—';
      }
    }

    function renderMenu() {
      elMenu.innerHTML = '';
      menuItems.forEach((item, idx) => {
        elMenu.appendChild(makeMenuButton(item, idx));
      });
      renderMenuSelection();
    }

    function renderMenuSelection() {
      const buttons = Array.from(elMenu.querySelectorAll('button'));
      buttons.forEach((b, i) => {
        const active = i === state.selectedIndex;
        b.classList.toggle('border-zinc-600/90', active);
        b.classList.toggle('bg-zinc-900/45', active);
        b.classList.toggle('shadow-[0_0_0_1px_rgba(255,255,255,0.03)]', active);
        b.setAttribute('aria-current', active ? 'true' : 'false');
      });
    }

    function escapeHTML(str) {
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    function executeMenu(id) {
      state.lastAction = id;
      setView('context');

      if (id === 'start') {
        setPanel({
          title: 'Mission Briefing',
          badge: 'ARMED',
          contentHTML: `
            <div class="space-y-3">
              <p class="text-sm text-zinc-300 leading-relaxed">
                Contract is minimal. Objective is clear: <span class="text-zinc-100">retrieve the zinc-core ledger</span>.
                No map. No markers. Only text.
              </p>
              <div class="rounded-lg border border-zinc-800/70 bg-zinc-950/30 p-3">
                <div class="text-xs text-zinc-500">LOADOUT</div>
                <ul class="mt-2 text-sm text-zinc-300 space-y-1">
                  <li><span class="text-zinc-500">•</span> Monoblade (quiet)</li>
                  <li><span class="text-zinc-500">•</span> Patch-kit (1)</li>
                  <li><span class="text-zinc-500">•</span> Signal scrambler (low power)</li>
                </ul>
              </div>
              <div class="rounded-lg border border-zinc-800/70 bg-zinc-950/30 p-3">
                <div class="text-xs text-zinc-500">RULES</div>
                <p class="mt-2 text-sm text-zinc-300 leading-relaxed">
                  Choices persist only inside this session. You are alone.
                </p>
              </div>
            </div>
          `,
          actions: [
            {
              label: 'Launch',
              onClick: () => {
                setPanel({
                  title: 'Deployment',
                  badge: 'RUNNING',
                  contentHTML: `
                    <div class="space-y-3">
                      <p class="text-sm text-zinc-300 leading-relaxed">
                        Boot sequence complete. You step into a street of wet metal and muted signage.
                      </p>
                      <div class="rounded-lg border border-zinc-800/70 bg-zinc-950/30 p-3">
                        <div class="text-xs text-zinc-500">PROMPT</div>
                        <p class="mt-2 text-sm text-zinc-300">
                          <span class="text-zinc-500">&gt;</span> Type your first command:
                        </p>
                        <div class="mt-2 flex gap-2">
                          <input id="cmd" class="flex-1 rounded-lg border border-zinc-700/70 bg-zinc-950/60 px-3 py-2 text-sm text-zinc-200 placeholder:text-zinc-600 focus:outline-none focus:ring-2 focus:ring-zinc-600/40" placeholder="look / inventory / move" />
                          <button id="sendCmd" class="px-3 py-2 text-sm rounded-lg border bg-zinc-900/40 border-zinc-700/70 text-zinc-200 hover:bg-zinc-800/60 hover:border-zinc-600/80 transition-colors">Send</button>
                        </div>
                        <div id="cmdOut" class="mt-3 text-sm text-zinc-400 leading-relaxed"></div>
                      </div>
                      <p class="text-xs text-zinc-500">No map will appear. Interpret the output.</p>
                    </div>
                  `,
                  actions: [
                    {
                      label: 'Abort to Menu',
                      onClick: () => backToMenu('Aborted. Returned to menu. No footprints left.')
                    }
                  ]
                });

                window.setTimeout(() => {
                  const inp = document.getElementById('cmd');
                  const btn = document.getElementById('sendCmd');
                  const out = document.getElementById('cmdOut');
                  if (!inp || !btn || !out) return;

                  const respond = (txt) => {
                    const safe = escapeHTML(txt);
                    out.innerHTML = `<div class="mt-2"><span class="text-zinc-500">&gt;</span> <span class="text-zinc-200">${escapeHTML(inp.value.trim())}</span></div>` +
                      `<div class="mt-1 text-zinc-400">${safe}</div>`;
                    inp.value = '';
                    inp.focus();
                  };

                  const handle = () => {
                    const cmd = (inp.value || '').trim().toLowerCase();
                    if (!cmd) return;
                    if (cmd === 'look') {
                      respond('A corridor of zinc panels. A door marked with a faded serial. The air smells like rain and circuitry.');
                    } else if (cmd === 'inventory') {
                      respond('Monoblade, patch-kit (1), signal scrambler. Everything else was left behind.');
                    } else if (cmd.startsWith('move')) {
                      respond('You move without a map. Footsteps measured. The terminal records only outcomes, not routes.');
                    } else {
                      respond('Command not recognized. Try: look, inventory, move');
                    }
                  };

                  btn.addEventListener('click', handle);
                  inp.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') handle();
                  });
                  inp.focus();
                }, 180);
              }
            },
            {
              label: 'Back to Menu',
              onClick: () => backToMenu('Standing by in menu.')
            }
          ]
        });
        elSystemNote.textContent = 'Briefing compiled. Awaiting your decision.';
      }

      if (id === 'load') {
        const slots = state.saveSlots;
        setPanel({
          title: 'Load Data',
          badge: 'SCAN',
          contentHTML: `
            <div class="space-y-3">
              <p class="text-sm text-zinc-300 leading-relaxed">Searching for local fragments…</p>
              <div class="rounded-lg border border-zinc-800/70 bg-zinc-950/30 p-3">
                <div class="text-xs text-zinc-500">RESULT</div>
                <div class="mt-2 text-sm text-zinc-300">
                  ${slots.length === 0
                    ? '<span class="text-zinc-400">No saves detected. (This lobby does not create saves by default.)</span>'
                    : slots.map((s, i) => `<div class="py-1"><span class="text-zinc-500">SLOT ${String(i+1).padStart(2,'0')}:</span> <span class="text-zinc-200">${escapeHTML(s.name)}</span> <span class="text-zinc-500">(${escapeHTML(s.time)})</span></div>`).join('')
                  }
                </div>
              </div>
              <p class="text-xs text-zinc-500">Tip: use Settings to toggle reduced output for quieter logs.</p>
            </div>
          `,
          actions: [
            {
              label: 'Simulate Save Fragment',
              onClick: () => {
                const now = new Date();
                state.saveSlots.unshift({
                  name: 'ALLEYWAY_CHECKPOINT',
                  time: now.toLocaleString(),
                });
                elSystemNote.textContent = 'A fragment appeared in local memory. It will not persist after refresh.';
                executeMenu('load');
              }
            },
            { label: 'Back to Menu', onClick: () => backToMenu('Returned to menu.') }
          ]
        });
        elSystemNote.textContent = 'Load subsystem is local-only. No network calls.';
      }

      if (id === 'settings') {
        setPanel({
          title: 'Settings',
          badge: 'TUNE',
          contentHTML: `
            <div class="space-y-3">
              <p class="text-sm text-zinc-300 leading-relaxed">
                Adjust the terminal atmosphere. Minimal changes. Zinc only.
              </p>

              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <label class="rounded-lg border border-zinc-800/70 bg-zinc-950/30 p-3 flex items-start gap-3 cursor-pointer select-none">
                  <input id="setFlicker" type="checkbox" class="mt-1" ${state.settings.textFlicker ? 'checked' : ''} />
                  <div>
                    <div class="text-sm text-zinc-200">Text flicker</div>
                    <div class="text-xs text-zinc-500 mt-1">Optional subtle instability on header text.</div>
                  </div>
                </label>

                <label class="rounded-lg border border-zinc-800/70 bg-zinc-950/30 p-3 flex items-start gap-3 cursor-pointer select-none">
                  <input id="setScanlines" type="checkbox" class="mt-1" ${state.settings.scanlines ? 'checked' : ''} />
                  <div>
                    <div class="text-sm text-zinc-200">Scanlines</div>
                    <div class="text-xs text-zinc-500 mt-1">Static CRT overlay (optimized).</div>
                  </div>
                </label>

                <label class="rounded-lg border border-zinc-800/70 bg-zinc-950/30 p-3 flex items-start gap-3 cursor-pointer select-none sm:col-span-2">
                  <input id="setReduced" type="checkbox" class="mt-1" ${state.settings.reducedOutput ? 'checked' : ''} />
                  <div>
                    <div class="text-sm text-zinc-200">Reduced output</div>
                    <div class="text-xs text-zinc-500 mt-1">Shorter messages in the lobby output panel.</div>
                  </div>
                </label>
              </div>

              <div class="rounded-lg border border-zinc-800/70 bg-zinc-950/30 p-3">
                <div class="text-xs text-zinc-500">KEYBINDS</div>
                <div class="mt-2 text-sm text-zinc-300 leading-relaxed">
                  In menu: <span class="text-zinc-200">Arrow keys</span> + <span class="text-zinc-200">Enter</span>.
                  In context: <span class="text-zinc-200">Esc</span> returns to menu.
                </div>
              </div>
            </div>
          `,
          actions: [
            {
              label: 'Apply',
              onClick: () => {
                const flick = document.getElementById('setFlicker')?.checked ?? false;
                const scan = document.getElementById('setScanlines')?.checked ?? true;
                const red = document.getElementById('setReduced')?.checked ?? false;
                state.settings.textFlicker = flick;
                state.settings.scanlines = scan;
                state.settings.reducedOutput = red;
                applySettings();
                elSystemNote.textContent = 'Settings applied. Stable output maintained.';
              }
            },
            { label: 'Back to Menu', onClick: () => backToMenu('Returned to menu.') }
          ]
        });
        elSystemNote.textContent = 'Tuning parameters are client-side only.';

        window.setTimeout(() => {
          const flick = document.getElementById('setFlicker');
          const scan = document.getElementById('setScanlines');
          const red = document.getElementById('setReduced');
          [flick, scan, red].forEach((x) => {
            if (!x) return;
            x.addEventListener('change', () => {
              state.settings.textFlicker = document.getElementById('setFlicker')?.checked ?? state.settings.textFlicker;
              state.settings.scanlines = document.getElementById('setScanlines')?.checked ?? state.settings.scanlines;
              state.settings.reducedOutput = document.getElementById('setReduced')?.checked ?? state.settings.reducedOutput;
              applySettings();
            });
          });
        }, 150);
      }

      if (id === 'credits') {
        setPanel({
          title: 'Credits',
          badge: 'INFO',
          contentHTML: `
            <div class="space-y-3">
              <p class="text-sm text-zinc-300 leading-relaxed">A minimal lobby interface for a text-based RPG.</p>
              <div class="rounded-lg border border-zinc-800/70 bg-zinc-950/30 p-3">
                <div class="text-xs text-zinc-500">STACK</div>
                <ul class="mt-2 text-sm text-zinc-300 space-y-1">
                  <li><span class="text-zinc-500">•</span> Tailwind (CDN)</li>
                  <li><span class="text-zinc-500">•</span> JetBrains Mono (Google Fonts)</li>
                  <li><span class="text-zinc-500">•</span> Plain JS</li>
                </ul>
              </div>
              <div class="rounded-lg border border-zinc-800/70 bg-zinc-950/30 p-3">
                <div class="text-xs text-zinc-500">LICENSE</div>
                <p class="mt-2 text-sm text-zinc-300 leading-relaxed">Use freely. Keep it subtle.</p>
              </div>
            </div>
          `,
          actions: [
            { label: 'Back to Menu', onClick: () => backToMenu('Returned to menu.') }
          ]
        });
        elSystemNote.textContent = 'Credits loaded. No external services contacted.';
      }
    }

    function setIdle() {
      const msg = state.settings.reducedOutput
        ? 'Awaiting command.'
        : 'Awaiting command. Context is idle.';

      setPanel({
        title: 'Idle',
        badge: 'READY',
        contentHTML: `
          <p class="text-sm text-zinc-300 leading-relaxed">${escapeHTML(msg)}</p>
          <div class="mt-4 grid grid-cols-2 gap-3">
            <div class="rounded-lg border border-zinc-800/70 bg-zinc-950/30 p-3">
              <div class="text-xs text-zinc-500">SAVE SLOTS</div>
              <div class="mt-1 text-sm text-zinc-200">${state.saveSlots.length} detected</div>
            </div>
            <div class="rounded-lg border border-zinc-800/70 bg-zinc-950/30 p-3">
              <div class="text-xs text-zinc-500">AMBIENCE</div>
              <div class="mt-1 text-sm text-zinc-200">Zinc, quiet</div>
            </div>
          </div>
        `,
        actions: [
          { label: 'Back to Menu', onClick: () => backToMenu('Returned to menu.') }
        ]
      });
    }

    function applySettings() {
      const title = document.getElementById('brandTitle');
      if (title) {
        title.classList.toggle('flicker', !!state.settings.textFlicker);
      }

      document.body.classList.toggle('scanlines', !!state.settings.scanlines);

      if (elPanelTitle?.textContent?.trim().toLowerCase() === 'idle' && state.view === 'context') {
        setIdle();
      }
    }

    function clamp(n, min, max) {
      return Math.max(min, Math.min(max, n));
    }

    function onKeydown(e) {
      const active = document.activeElement;
      const isTyping = active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA');
      if (isTyping) {
        if (e.key === 'Escape') {
          active.blur();
          e.preventDefault();
        }
        return;
      }

      if (state.view === 'context') {
        if (e.key === 'Escape') {
          backToMenu('Returned to menu.');
          e.preventDefault();
        }
        return;
      }

      // Menu view controls
      if (e.key === 'ArrowDown') {
        state.selectedIndex = clamp(state.selectedIndex + 1, 0, menuItems.length - 1);
        renderMenuSelection();
        e.preventDefault();
      } else if (e.key === 'ArrowUp') {
        state.selectedIndex = clamp(state.selectedIndex - 1, 0, menuItems.length - 1);
        renderMenuSelection();
        e.preventDefault();
      } else if (e.key === 'Enter') {
        const item = menuItems[state.selectedIndex];
        if (item) executeMenu(item.id);
        e.preventDefault();
      }
    }

    function tickClock() {
      const d = new Date();
      const hh = String(d.getHours()).padStart(2, '0');
      const mm = String(d.getMinutes()).padStart(2, '0');
      const ss = String(d.getSeconds()).padStart(2, '0');
      const clock = document.getElementById('clock');
      if (clock) clock.textContent = `${hh}:${mm}:${ss}`;
    }

    // Init
    document.getElementById('year').textContent = String(new Date().getFullYear());
    renderMenu();
    setIdle();
    applySettings();
    tickClock();
    window.setInterval(tickClock, 1000);

    document.getElementById('backToMenuBtn')?.addEventListener('click', () => backToMenu('Returned to menu.'));
    window.addEventListener('keydown', onKeydown);

    // Start in menu-only view
    setView('menu');
  </script>
</body>
</html>
